{% extends "website/master.html" %}

{% block title %}
    reservation_form.html
{% endblock %}

{% block extra_css %}
<style>
/* --- TABLE → GRID --- */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 20px 15px;
}

tr {
    display: flex;
    align-items: center;
    gap: 20px;
}

th {
    flex: 1;
    text-align: center;
    font-weight: 600;
}

td {
    position: relative;
    flex: 3;
}

/* --- INPUTS --- */
input, select, textarea {
    width: 100%;
    height: 44px;
    padding: 10px 12px;
    border: 1px solid #dcdfe6;
    border-radius: 6px;
    font-size: 15px;
}

input:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: #2f5bea;
}

input[type="number"] {
    text-align: center;
}

input[type="radio"],
input[type="checkbox"] {
    width: auto;
}

/* --- MAP --- */
#map {
    width: 100%;
    height: 380px;
    border-radius: 10px;
}

/* --- ROUTE INFO --- */
#route-info,
#route-info-2 {
    background: #f5f5f5;
    border: 1px solid #dcdfe6;
    border-radius: 6px;
    padding: 12px 16px;
    color: #222;
    font-weight: 600;
    margin: 10px 0;
    display: none;
}

/* --- Affichage lorsque contenu présent --- */
#route-info[data-visible="true"],
#route-info-2[data-visible="true"] {
    display: block;
}


/* --- SUGGESTIONS --- */
.suggestions {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    width: 100%;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 6px 18px rgba(0,0,0,.08);
    text-align: left;
}

.suggestions div {
    padding: 10px;
    cursor: pointer;
}

.suggestions div:hover {
    background: #f0f0f0;
}

/* --- RESPONSIVE --- */
@media (max-width: 900px) {
    tr {
        flex-direction: column;
    }

    th, td {
        width: 100%;
    }

    #map {
        height: 300px;
    }
}
</style>
{% endblock %}


{% block content %}
<div class="card">
    <h1>Page de réservation</h1>
    <form action="{% url 'confirm_reservation' %}" method="post">
    {% csrf_token %}
        <table>
            <tr>
<!--                <th>{{ form.address_start.label_tag }}</th>-->
                <th>Adresse de départ</th>
                <td>
                    {{ form.address_start }}
                    <div id="suggestions_start" class="suggestions" style="display:none;"></div>
                </td>
            </tr>

            <tr>
<!--                <th>{{ form.address_end.label_tag }}</th>-->
                <th>Adresse d'arrivée</th>
                <td>
                    {{ form.address_end }}
                    <div id="suggestions_end" class="suggestions" style="display:none;"></div>
                </td>
            </tr>

            <tr>
                <th>
                    <div id="route-info" style="margin: 10px 0; font-weight: bold;"></div>
                    <div id="route-info-2" style="margin: 10px 0; font-weight: bold;"></div>
                </th>
                <td>
                    <div id="map" data-mapbox-token="{{ mapbox_token }}" style="width: 100%; height: 400px; margin: 20px 0;"></div>
                </td>
            </tr>
            <tr>
<!--                <th>{{ form.car_type.label_tag }}</th>-->
                <th>Véhicule</th>
                <td>
                    {{ form.car_type }}
                    {{ form.car_type.errors }}
                </td>
            </tr>
            <tr>
<!--                <th>{{ form.trip_type.label_tag }}</th>-->
                <th>Type de trajet</th>
                <td>{{ form.trip_type }}</td>
            </tr>
            <tr>
<!--                <th>{{ form.date_start.label_tag }}</th>-->
                <th>Date de départ</th>
                <td>{{ form.date_start }}</td>
            </tr>
            <tr>
<!--                <th>{{ form.time_start.label_tag }}</th>-->
                <th>Heure de départ</th>
                <td>{{ form.time_start }}</td>
            </tr>

            <tr>
<!--                <th>{{ form.nb_passengers.label_tag }}</th>-->
                <th>Nombre de passagers</th>
                <td>{{ form.nb_passengers }}</td>
            </tr>
            <tr>
<!--                <th>{{ form.nb_luggages.label_tag }}</th>-->
                <th>Nombre de bagages</th>
                <td>{{ form.nb_luggages }}</td>
            </tr>
            <tr>
<!--                <th>{{ form.last_name.label_tag }}</th>-->
                <th>Nom de famille</th>
                <td>{{ form.last_name }}</td>
            </tr>
            <tr>
<!--                <th>{{ form.first_name.label_tag }}</th>-->
                <th>Prénom</th>
                <td>{{ form.first_name }}</td>
            </tr>
            <tr>
<!--                <th>{{ form.phone.label_tag }}</th>-->
                <th>Téléphone</th>
                <td>{{ form.phone }}</td>
            </tr>
            <tr>
<!--                <th>{{ form.email.label_tag }}</th>-->
                <th>Email</th>
                <td>{{ form.email }}</td>
            </tr>
            <tr>
<!--                <th>{{ form.note.label_tag }}</th>-->
                <th>Commentaires</th>
                <td>{{ form.note }}</td>
            </tr>
            <tr>
                <td>
                    <input type="checkbox" id="data_agreement" name="data_agreement" value="check" >
                    <label for="data_agreement">En cochant cette case, vous acceptez que vos données fournies soient utilisées pour le traitement de votre demande.</label>
                </td>
            </tr>
        </table>

        <input type="hidden" id="distance" name="distance">
        <input type="hidden" id="duration" name="duration">
        <input type="hidden" id="price" name="price">

        <button type="submit">Commander</button>
    </form>
</div>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>

{{ vehicule_prices|json_script:"vehicule-prices" }}
{{ vehicule_seats|json_script:"vehicule-seats" }}

<script>
const VEHICULE_PRICES = JSON.parse(document.getElementById("vehicule-prices").textContent);
const VEHICULE_SEATS = JSON.parse(document.getElementById("vehicule-seats").textContent);

document.addEventListener("DOMContentLoaded", () => {
    // Initialisation des data-attributes prix et sièges
    const carSelect = document.getElementById("id_car_type");
    if (carSelect) {
        for (let option of carSelect.options) {
            const val = option.value;
            if (!val) continue;
            option.dataset.price = VEHICULE_PRICES[val] ?? 0;
            option.dataset.seats = VEHICULE_SEATS[val] ?? 0;
        }
    }
    carSelect.addEventListener("change", () => {
        validatePassengers(); // optionnel, tu l’as déjà
        updatePrice();         // ← recalculer le prix à chaque changement de véhicule
    });

    // Mapbox
    const token = document.getElementById("map").dataset.mapboxToken;
    mapboxgl.accessToken = token;

    let map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v12",
        center: [2.3522, 48.8566],
        zoom: 11
    });

    let startCoords = null;
    let endCoords = null;
    let startMarker = null;
    let endMarker = null;
    let mapLoaded = false;
    let currentDistanceKm = 0;

    map.on("load", () => {
        mapLoaded = true;
        map.addSource("route", { type: "geojson", data: { type: "FeatureCollection", features: [] } });
        map.addLayer({
            id: "route",
            type: "line",
            source: "route",
            layout: { "line-join": "round", "line-cap": "round" },
            paint: { "line-width": 6, "line-color": ["get", "color"] }
        });
    });

    // Autocomplétion Mapbox
    async function geocodeAddress(inputId, suggestionsId, callback) {
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);

        input.addEventListener("input", async () => {
            const value = input.value.trim();
            if (value.length < 3) { suggestions.style.display = "none"; return; }

            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(value)}.json?autocomplete=true&limit=5&language=fr&country=fr&access_token=${mapboxgl.accessToken}`;
            const response = await fetch(url);
            const data = await response.json();
            if (!data.features.length) { suggestions.style.display = "none"; return; }

            suggestions.innerHTML = "";
            suggestions.style.display = "block";

            data.features.forEach(feature => {
                let item = document.createElement("div");
                item.textContent = feature.place_name;
                item.addEventListener("click", () => {
                    input.value = feature.place_name;
                    suggestions.style.display = "none";
                    callback(feature.geometry.coordinates);
                });
                suggestions.appendChild(item);
            });
        });

        document.addEventListener("click", e => {
            if (!suggestions.contains(e.target) && e.target !== input) suggestions.style.display = "none";
        });
    }

    function setupMarker(inputId, suggestionsId, color, setCoordsCallback) {
        geocodeAddress(inputId, suggestionsId, coords => {
            setCoordsCallback(coords);
            if (inputId === "id_address_start") {
                if (startMarker) startMarker.remove();
                startMarker = new mapboxgl.Marker({ color }).setLngLat(coords).addTo(map);
            } else {
                if (endMarker) endMarker.remove();
                endMarker = new mapboxgl.Marker({ color }).setLngLat(coords).addTo(map);
            }
            updateRouteSimple();
        });
    }

    setupMarker("id_address_start", "suggestions_start", "green", coords => startCoords = coords);
    setupMarker("id_address_end", "suggestions_end", "red", coords => endCoords = coords);

    function colorByCongestion(level) {
        switch(level) {
            case "low": return "#2ECC71";
            case "moderate": return "#F1C40F";
            case "heavy": return "#E67E22";
            case "severe": return "#E74C3C";
            default: return "#0077ff";
        }
    }

    async function updateRouteSimple() {
        if (!mapLoaded || !startCoords || !endCoords) return;

        const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${startCoords[0]},${startCoords[1]};${endCoords[0]},${endCoords[1]}?geometries=geojson&overview=full&access_token=${mapboxgl.accessToken}`;
        try {
            const response = await fetch(url);
            const json = await response.json();
            if (!json.routes || !json.routes.length) return;

            const route = json.routes[0];
            const coords = route.geometry.coordinates;
            currentDistanceKm = parseFloat(route.distance / 1000);

            const geojson = { type: "FeatureCollection", features: [{ type: "Feature", geometry: { type: "LineString", coordinates: coords } }] };
            map.getSource("route").setData(geojson);

            map.fitBounds([startCoords, endCoords], { padding: 50 });
            document.getElementById("distance").value = currentDistanceKm;

            updatePrice();
            updateRouteWithTraffic();
        } catch (err) {
            console.error(err);
        }
    }

    async function updateRouteWithTraffic() {
        if (!mapLoaded || !startCoords || !endCoords) return;
        const dateInput = document.getElementById("id_date_start").value;
        const timeInput = document.getElementById("id_time_start").value;
        if (!dateInput || !timeInput) return;

        const departAt = `${dateInput}T${timeInput}`;
        const url = `https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${startCoords[0]},${startCoords[1]};${endCoords[0]},${endCoords[1]}?geometries=geojson&overview=full&annotations=duration,congestion&depart_at=${departAt}&access_token=${mapboxgl.accessToken}`;

        try {
            const response = await fetch(url);
            const json = await response.json();
            if (!json.routes || !json.routes.length) return;

            const route = json.routes[0];
            const coords = route.geometry.coordinates;
            const congestions = route.legs[0].annotation.congestion;

            let features = [];
            for (let i = 0; i < coords.length - 1; i++) {
                features.push({
                    type: "Feature",
                    geometry: { type: "LineString", coordinates: [coords[i], coords[i+1]] },
                    properties: { color: colorByCongestion(congestions[i]) }
                });
            }

            if (map.getSource("route")) {
                map.getSource("route").setData({ type: "FeatureCollection", features });
            }

            map.fitBounds([startCoords, endCoords], { padding: 50 });

            const durationTrafficMin = Math.round(route.duration / 60);
            document.getElementById("duration").value = durationTrafficMin;
            document.getElementById("route-info").innerHTML = `Durée estimée : ${durationTrafficMin} min (avec trafic)`;

            updatePrice();
            updateRouteInfoVisibility();
        } catch (err) {
            console.error(err);
        }
    }

    function updateRouteInfoVisibility() {
        const info = document.getElementById("route-info");
        const info2 = document.getElementById("route-info-2");
        info.dataset.visible = info.innerHTML.trim() !== "";
        info2.dataset.visible = info2.innerHTML.trim() !== "";
    }

    function updatePrice() {
        const carSelect = document.getElementById("id_car_type");
        const tripSelect = document.getElementById("id_trip_type");
        const priceInfo = document.getElementById("route-info-2");

        if (!carSelect || !carSelect.value) {
            priceInfo.innerHTML = "";
            updateRouteInfoVisibility();
            return;
        }

        const selectedCar = carSelect.options[carSelect.selectedIndex];
        const pricePerKm = parseFloat(selectedCar.dataset.price || 0);

        // Calcul en centimes pour éviter les imprécisions
        let distanceCm = Math.round(currentDistanceKm * 100); // distance * 100
        let priceCm = distanceCm * pricePerKm; // multiplication en "centi-euros"

        // Multiplier selon le type de trajet
        let multiplier = tripSelect && tripSelect.value === "2" ? 2 : 1;
        priceCm = Math.round(priceCm * multiplier);

        // Convertir en euros avec 2 décimales
        let finalPrice = priceCm / 100;

        priceInfo.innerHTML = `Distance : ${currentDistanceKm.toFixed(2)} km — Prix estimé : ${finalPrice.toFixed(2)} €`;
        document.getElementById("price").value = finalPrice.toFixed(2);

        updateRouteInfoVisibility();
    }

    // Événements pour date/heure et trajet
    document.getElementById("id_date_start").addEventListener("change", updateRouteWithTraffic);
    document.getElementById("id_time_start").addEventListener("change", updateRouteWithTraffic);
    const tripTypeSelect = document.getElementById("id_trip_type");
    if (tripTypeSelect) tripTypeSelect.addEventListener("change", updatePrice);

    // Validation des passagers
    const passengerInput = document.getElementById("id_nb_passengers");
    function validatePassengers() {
        const nb = parseInt(passengerInput.value || 0);
        const selectedOption = carSelect.options[carSelect.selectedIndex];
        if (!selectedOption) return;

        const maxSeats = parseInt(selectedOption.dataset.seats);

        // Empêche les valeurs négatives
        if (nb < 0) passengerInput.value = 0;

        // Empêche de dépasser le max du véhicule
        if (nb > maxSeats) passengerInput.value = maxSeats;
    }
    passengerInput.addEventListener("input", validatePassengers);
    carSelect.addEventListener("change", validatePassengers);

    // Remplissage des champs cachés avant submit
    const form = document.querySelector("form");
    form.addEventListener("submit", (e) => {
        // Met à jour le prix si nécessaire
        updatePrice();

        // Remplit les champs cachés
        document.getElementById("distance").value = currentDistanceKm.toFixed(2) || 0;

        const durationEl = document.getElementById("duration");
        if (!durationEl.value || durationEl.value === "0") {
            // Si duration non calculée, mettre une valeur par défaut (ou laisser à 0)
            durationEl.value = 0;
        }

        const priceEl = document.getElementById("price");
        if (!priceEl.value || priceEl.value === "0") {
            priceEl.value = (currentDistanceKm * parseFloat(document.getElementById("id_car_type").selectedOptions[0]?.dataset.price || 0)).toFixed(2);
        }
    });

        // Remplit le public_token si nécessaire
<!--        const publicTokenEl = document.getElementById("public_token");-->
<!--        if (!publicTokenEl.value) {-->
<!--            publicTokenEl.value = mapboxgl.accessToken;-->
<!--        }-->
    });
</script>

{% endblock %}